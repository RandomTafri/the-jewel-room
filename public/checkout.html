<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Shree Roop Creative</title>
    <link rel="icon" type="image/png" href="images/logo.png">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        /* Mobile Checkout Layout Fix */
        .checkout-layout {
            display: flex;
            gap: 40px;
            align-items: flex-start;
            flex-direction: column-reverse;
            /* Summary on top for mobile */
        }

        .checkout-form-section {
            flex: 2;
            width: 100%;
        }

        .checkout-summary-section {
            flex: 1;
            width: 100%;
            background: #fafafa;
            padding: 20px;
            border: 1px solid #eee;
        }

        @media (min-width: 768px) {
            .checkout-layout {
                flex-direction: row;
                /* Side-by-side on desktop */
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="container flex justify-between items-center">
            <div class="logo"><a href="index.html"
                    style="display: flex; align-items: center; text-decoration: none; color: #333;">
                    <img src="images/logo.png" alt="Shree Roop Creative"
                        style="height: 60px; vertical-align: middle; margin-right: 15px;">
                    <span
                        style="font-family: 'Cinzel', serif; font-size: 1.5rem; font-weight: 700; letter-spacing: 1px; color: #d4af37;">Shree
                        Roop Creative</span>
                </a></div>
        </div>
    </header>

    <div class="container section checkout-layout">
        <div class="checkout-form-section">
            <h2>Checkout</h2>
            <form id="checkout-form" style="display: grid; gap: 15px; margin-top: 20px;">
                <!-- If not logged in, ask for guest details, but we will protect this page via JS for simplicity or allow guest checkout -->
                <!-- We will allow guest checkout -->

                <h3>Contact & Shipping</h3>
                <input type="text" id="name" placeholder="Full Name" required class="input-field"
                    style="padding: 10px; border: 1px solid #ccc;">
                <input type="email" id="email" placeholder="Email Address" required class="input-field"
                    style="padding: 10px; border: 1px solid #ccc;">
                <input type="tel" id="phone" placeholder="Phone Number" required class="input-field"
                    style="padding: 10px; border: 1px solid #ccc;">
                <textarea id="address" placeholder="Full Shipping Address" rows="4" required class="input-field"
                    style="padding: 10px; border: 1px solid #ccc;"></textarea>

                <h3 style="margin-top: 20px;">Payment Method</h3>
                <div
                    style="margin-bottom: 15px; padding: 15px; background: #e8f5e9; border: 1px solid #c8e6c9; border-radius: 6px;">
                    <p style="margin: 0; color: #2e7d32; font-weight: bold; font-size: 1.1rem;"><i
                            class="fa-brands fa-whatsapp"></i> WhatsApp Confirmation</p>
                    <p style="margin: 5px 0 0 0; font-size: 0.9rem; color: #1b5e20;">Upon placing your order, our team
                        will instantly connect with you on WhatsApp to manually process your payment and arrange
                        shipping.</p>
                </div>

                <button type="submit" class="btn"
                    style="width: 100%; margin-top: 10px; background: #25D366; border-color: #25D366;"><i
                        class="fa-brands fa-whatsapp"></i> Place Order</button>
            </form>
        </div>

        <div class="checkout-summary-section">
            <h3 style="margin-top: 0;">Order Summary</h3>
            <div id="order-summary">Loading...</div>
            <hr style="margin: 15px 0;">
            <h3>Total: <span id="checkout-total">0</span></h3>
        </div>
    </div>

    <script src="js/app.js"></script>
    <script>
        let cartTotal = 0;
        let cartItems = [];

        async function initCheckout() {
            // Check auth, if logged in fill details
            if (State.user) {
                document.getElementById('name').value = State.user.name;
                document.getElementById('email').value = State.user.email;
                if (State.user.phone) document.getElementById('phone').value = State.user.phone;
            }

            // Load Cart
            const discountCoupon = localStorage.getItem('coupon');
            let url = '/cart';
            if (discountCoupon) url += '?coupon=' + discountCoupon;

            const res = await API.get(url);
            cartItems = res.items;
            if (cartItems.length === 0) {
                window.location.href = 'cart.html';
                return;
            }

            cartTotal = res.total;
            const subtotal = res.subtotal;
            const discountAmount = res.discount ? res.discount.discountAmount : 0;
            const discountMessage = res.discount ? res.discount.message : '';

            const summaryDiv = document.getElementById('order-summary');
            let html = cartItems.map(i => `
                <div class="flex justify-between" style="margin-bottom: 10px; font-size: 0.9rem;">
                    <span>${i.name} x ${i.quantity}</span>
                    <span>${formatPrice(i.price * i.quantity)}</span>
                </div>
            `).join('');

            html += '<hr style="margin: 15px 0;">';
            html += `
                <div class="flex justify-between" style="font-size: 0.9rem;">
                    <span>Subtotal:</span>
                    <span>${formatPrice(subtotal)}</span>
                </div>
            `;
            if (discountAmount > 0) {
                html += `
                 <div class="flex justify-between" style="font-size: 0.9rem; color: var(--success);">
                     <span>Coupon Discount:</span>
                     <span>-${formatPrice(discountAmount)}</span>
                 </div>
                 `;
            } else if (discountCoupon) {
                html += `
                 <div style="font-size: 0.8rem; color: red;">
                     Coupon failed: ${discountMessage}
                 </div>
                 `;
            }

            summaryDiv.innerHTML = html;

            document.getElementById('checkout-total').innerText = formatPrice(cartTotal);
        }

        document.getElementById('checkout-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!State.user) {
                // For guest checkout we still need a user mechanism or just create order with user_id null.
                // Our DB for orders has user_id, but we can make it nullable or create a temporary user. 
                // For this template, let's force login for simplicity or assume token is present (we have auth requirement).
                // "Customer registration + login" was a requirement. 
                // But typically guests can checkout.
                // Let's prompt login if not logged in.

                if (!confirm('You are checking out as a Guest. Click OK to continue or Cancel to Login.')) {
                    window.location.href = 'account.html';
                    return;
                }
                // NOTE: The backend expects a logged in user for `orders` table `user_id` OR we must modify backend.
                // The prompt says "Persistent cart: For guests... convert to DB cart AFTER login".
                // And "Checkout: creates order in DB".
                // It does not explicitly forbid guest checkout, but usually ecommerce allows it. 
                // However, `orders.user_id` is a FK. It should be nullable if we allow guest orders.
                // My schema init script for `orders` has `user_id INTEGER REFERENCES users(id)`, it's not NOT NULL.
                // So it is nullable. OK.
            }

            // NOTE: My order creation API `server/routes/orders.js` uses `authenticateToken` middleware and `req.user.id`. 
            // This means I ENFORCED login for ordering in my backend implementation. 
            // Retracting: I need to allow checkout without token OR force login.
            // Given "Customer registration + login" is a header feature, I will force login for this MVP template to keep it clean.
            // Or I can modify the backend to be optional auth. I will stick to "Force Login" for simplicity in this turn unless I change backend.
            // Wait, "Persistent cart ... For guests: store cart in localStorage and convert to DB cart after login" implies login is the expected path to persistent state.
            // Let's Alert user to login.

            if (!State.token) {
                alert('Please login to checkout.');
                window.location.href = 'account.html?redirect=checkout.html';
                return;
            }

            const paymentMethod = 'WHATSAPP';
            const data = {
                customerName: document.getElementById('name').value,
                customerPhone: document.getElementById('phone').value,
                shippingAddress: document.getElementById('address').value,
                items: cartItems,
                paymentMethod,
                totalAmount: cartTotal,
                couponCode: localStorage.getItem('coupon')
            };

            try {
                const res = await API.post('/orders', data);

                if (paymentMethod === 'ONLINE') {
                    // Hidden
                } else {
                    // WhatsApp Success
                    window.location.href = `success.html?orderId=${res.orderId}&total=${cartTotal}`;
                }

            } catch (e) {
                console.error(e);
                alert('Order creation failed');
            }
        });

        document.addEventListener('DOMContentLoaded', initCheckout);
    </script>
    <footer id="site-footer"></footer>
    <script src="js/footer.js"></script>
    <script src="js/mobile-header.js"></script>
</body>

</html>